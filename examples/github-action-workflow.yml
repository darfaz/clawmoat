# ClawMoat CI/CD Integration Examples
# Add this to your repo's .github/workflows/ directory
#
# Example 1: Scan PR diffs for prompt injection & secret leaks
# Example 2: Scan agent config files before deployment
# Example 3: Full project scan on push to main

# â”€â”€â”€ Example 1: PR Security Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: ClawMoat Security Scan
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  clawmoat-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ClawMoat
        run: npm install -g clawmoat

      # Scan all text/config files for prompt injection, secrets, PII
      - name: Scan for threats
        run: |
          echo "## ðŸ° ClawMoat Security Scan" >> $GITHUB_STEP_SUMMARY

          # Scan changed files in PR
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD -- '*.md' '*.yml' '*.yaml' '*.json' '*.txt' '*.env*' '*.js' '*.ts' '*.py')
          else
            FILES=$(find . -type f \( -name "*.md" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.js" -o -name "*.ts" -o -name "*.py" \) -not -path "*/node_modules/*" -not -path "*/.git/*")
          fi

          FOUND_ISSUES=0
          for file in $FILES; do
            if [ -f "$file" ]; then
              RESULT=$(clawmoat scan "$file" --format json 2>/dev/null || true)
              if echo "$RESULT" | grep -q '"blocked":true'; then
                echo "â›” **BLOCKED** â€” $file" >> $GITHUB_STEP_SUMMARY
                echo "$RESULT" | jq -r '.findings[] | "  - \(.severity): \(.type)/\(.subtype)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null
                FOUND_ISSUES=1
              fi
            fi
          done

          if [ "$FOUND_ISSUES" = "1" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Security issues found. Review above findings." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No security issues found." >> $GITHUB_STEP_SUMMARY
          fi

      # Scan OpenClaw skills if present
      - name: Scan skills (supply chain)
        if: always()
        run: |
          if [ -d "skills/" ]; then
            clawmoat audit skills/ --format summary >> $GITHUB_STEP_SUMMARY
          fi

# â”€â”€â”€ Example 2: Pre-deployment Agent Config Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Uncomment and adapt for your deployment pipeline:
#
# deploy-scan:
#   runs-on: ubuntu-latest
#   steps:
#     - uses: actions/checkout@v4
#     - uses: actions/setup-node@v4
#       with: { node-version: '20' }
#     - run: npm install -g clawmoat
#     - name: Validate agent configs
#       run: |
#         # Scan YAML configs for dangerous patterns
#         for f in config/*.yml agents/*.yml; do
#           clawmoat scan "$f" --fail-on high
#         done
#     - name: Scan prompts for injection
#       run: |
#         # Scan prompt templates
#         for f in prompts/*.md prompts/*.txt; do
#           clawmoat scan "$f" --fail-on critical
#         done
